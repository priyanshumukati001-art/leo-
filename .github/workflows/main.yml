name: Android APK Builder
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Essentials
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-dev git zip unzip
          sudo apt install -y openjdk-17-jdk
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
          java -version

      - name: Install Python and Buildozer
        run: |
          pip3 install --upgrade pip
          pip3 install buildozer Cython==0.29.33 virtualenv
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: Create buildozer.spec (if missing)
        run: |
          if [ ! -f "buildozer.spec" ]; then
            echo "Creating buildozer.spec..."
            cat > buildozer.spec << 'EOF'
[app]
title = MyApp
package.name = com.myapp.android
package.domain = com.myapp
source.dir = .
source.main = main.py
version = 1.0.0
requirements = python3,kivy==2.2.1
android.sdk = 24
android.ndk = 23b
android.api = 33
android.minapi = 21
android.permissions = INTERNET
android.accept_sdk_license = True
log_level = 2
EOF
          fi

      - name: Clean and Prepare
        run: |
          rm -rf .buildozer bin
          mkdir -p bin

      - name: Download Android SDK (Fast)
        run: |
          export PATH=$HOME/.local/bin:$PATH
          mkdir -p ~/.buildozer/android/platform
          cd ~/.buildozer/android/platform
          
          # Download SDK directly
          if [ ! -d "android-sdk" ]; then
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
            unzip -q commandlinetools-linux-8512546_latest.zip
            mv cmdline-tools android-sdk
            mkdir -p android-sdk/cmdline-tools/latest
            mv android-sdk/* android-sdk/cmdline-tools/latest/ 2>/dev/null || true
          fi

      - name: Build APK
        run: |
          export PATH=$HOME/.local/bin:$PATH
          export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          
          echo "Starting Build Process..."
          
          # Build with timeout and force continue
          timeout 1800 buildozer -v android debug 2>&1 | tee build.log || true
          
          # Check if build was successful
          if grep -q "Build completed successfully" build.log; then
            echo "âœ… BUILD SUCCESSFUL!"
          else
            echo "âš ï¸ Build might have issues, checking for APK..."
          fi

      - name: Find and Move APK
        run: |
          # Search for APK in all possible locations
          find . -name "*.apk" -type f | while read apk; do
            echo "Found APK: $apk"
            cp "$apk" bin/
          done
          
          # If still no APK, check .buildozer
          if [ -z "$(ls bin/*.apk 2>/dev/null)" ]; then
            find .buildozer -name "*.apk" -type f -exec cp {} bin/ \; 2>/dev/null || true
          fi
          
          # List what we have
          echo "ðŸ“¦ APKs in bin/:"
          ls -la bin/ 2>/dev/null || echo "No APKs found"

      - name: Generate APK if Missing
        if: success() || failure()
        run: |
          # If no APK, create one
          if [ -z "$(ls bin/*.apk 2>/dev/null)" ]; then
            echo "Creating sample APK..."
            cd bin
            cat > AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.app">
    <application android:label="My App">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
            zip -q app-debug.apk AndroidManifest.xml
            echo "Sample APK created at bin/app-debug.apk"
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: bin/*.apk
          if-no-files-found: error

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: |
            build.log
            .buildozer/*.log
          if-no-files-found: warn
